<!-- courseDashboard-content.html -->
<!-- èª²ç¨‹ç®¡ç†è¦–åœ– -->
<div id="courseDashboard-view" class="view">
  <div class="container">
    <div class="header">
      <h2>èª²ç¨‹ç®¡ç†</h2>
      <a href="#" id="help-link">â“˜ æ“ä½œè¬›è§£</a>
    </div>
    <div id="schedule-list">
      <!-- JavaScript æœƒåœ¨é€™è£¡å‹•æ…‹æ’å…¥å¡ç‰‡ -->
    </div>
  </div>
</div>

<!-- æ“ä½œè¬›è§£è¦–åœ–ï¼ˆé è¨­éš±è—ï¼‰ -->
<div id="help-view" class="view" style="display: none;">
  <div class="container">
    <div class="header">
      <h2>æ“ä½œè¬›è§£</h2>
      <a href="#" id="back-link">è¿”å›</a>
    </div>
    <h2>1ï¸âƒ£ æ¢¯æ¬¡åˆ·æ–°</h2>
    <h3>ğŸ‘‰ åŒæ­¥ Google Drive è³‡æ–™å¤¾ï¼Œç¢ºä¿èª²ç¨‹åˆ—è¡¨ç‚ºæœ€æ–°ç‰ˆæœ¬ï¼š</h3>
    <ul>
      <li>ğŸ“‚ <strong>è®€å–</strong> ä½ æŒ‡å®šçš„æ¢¯æ¬¡å°æ‡‰çš„ Google Drive è³‡æ–™å¤¾ã€‚</li>
      <li>ğŸ” <strong>æ¯”å°</strong> ç¾æœ‰è³‡æ–™ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦ <strong>åŠ å…¥ã€åˆªé™¤æˆ–æ›´æ–°</strong> èª²å ‚ã€‚</li>
      <li>ğŸ”„ <strong>æ›´æ–°</strong> è³‡æ–™åº«ï¼Œç¢ºä¿ <strong>æª”æ¡ˆID å’Œåç¨±éƒ½æ˜¯æœ€æ–°çš„</strong>ã€‚</li>
    </ul>
    <h3>ğŸ”¹ æ€éº¼æ“ä½œï¼Ÿ</h3>
    <ul>
      <li>é»æ“Š <strong>ã€Œæ¢¯æ¬¡åˆ·æ–°ã€</strong> æŒ‰éˆ•ã€‚</li>
      <li>ç³»çµ±æœƒé€²è¡ŒåŒæ­¥ï¼Œä¸¦å›å ±ã€Œæ–°å¢/ä¿®æ”¹/åˆªé™¤ã€çš„å…§å®¹ã€‚</li>
    </ul>
    <div class="tip">
      âš ï¸ <strong>å°æé†’</strong>ï¼š
      <ul>
        <li>å¦‚æœæ¢¯æ¬¡å…§ <strong>æ²’æœ‰è®Šå‹•</strong>ï¼Œç³»çµ±æœƒå›å ±ã€Œç„¡éœ€æ›´æ–°ã€ã€‚</li>
        <li>å¦‚æœæŸå€‹æ¢¯æ¬¡ <strong>é‚„æ²’å»ºç«‹</strong>ï¼Œç³»çµ±æœƒå›å ±ã€Œæ•¸æ“šç¼ºå¤±ã€ã€‚</li>
      </ul>
    </div>
    <h2>2ï¸âƒ£ æ¢¯æ¬¡ç‹€æ…‹</h2>
    <h3>ğŸ‘‰ <strong>é–‹å•Ÿæˆ–é—œé–‰</strong> æŸå€‹æ¢¯æ¬¡çš„èª²å¾Œé›²ç«¯ï¼š</h3>
    <ul>
      <li>âœ… <strong>é–‹å•Ÿ</strong>ï¼šå­¸ç”Ÿå¯ä»¥ç”³è«‹è§€çœ‹èª²ç¨‹ã€‚</li>
      <li>ğŸš« <strong>é—œé–‰</strong>ï¼šæš«åœè©²æ¢¯æ¬¡çš„å½±ç‰‡å…±äº«ï¼Œç„¡æ³•ç”³è«‹è§€çœ‹ã€‚</li>
    </ul>
    <h3>ğŸ”¹ æ€éº¼æ“ä½œï¼Ÿ</h3>
    <ul>
      <li>é¸æ“‡ <strong>ã€Œé–‹å•Ÿæ¢¯æ¬¡ã€</strong> æˆ– <strong>ã€Œé—œé–‰æ¢¯æ¬¡ã€</strong> æŒ‰éˆ•ã€‚</li>
      <li>ç³»çµ±æœƒè®Šæ›´è©²æ¢¯æ¬¡çš„ç‹€æ…‹ï¼Œä¸¦é¡¯ç¤ºçµæœã€‚</li>
    </ul>
  </div>
</div>

<script>
  /* ä»¥ä¸‹æ˜¯èª²ç¨‹ç®¡ç†é é¢çš„ JavaScript ç¨‹å¼ç¢¼ï¼ˆèˆ‡åŸæœ¬ courseDashboard.html ä¸­çš„å…§å®¹ç›¸åŒï¼‰
     â€» å»ºè­°å°‡é€™äº›å…±ç”¨å‡½å¼ï¼ˆä¾‹å¦‚ renderListã€syncData ç­‰ï¼‰æŠ½å‡ºæˆå…±ç”¨æª”æ¡ˆï¼Œ
       æˆ–è‡³å°‘ç¢ºä¿è¼‰å…¥å¾ŒåªåŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–ã€‚
  */
  let items = [];  // å­˜æ”¾èª²ç¨‹è³‡æ–™

  async function initCourseDashboard() {
    try {
      console.log("CourseDashboard: LIFF å·²åˆå§‹åŒ–");
      document.getElementById("help-link").addEventListener("click", showHelpView);
      document.getElementById("back-link").addEventListener("click", showIndexView);        
    } catch (err) {
      console.error("èª²ç¨‹ç®¡ç†é é¢åˆå§‹åŒ–éŒ¯èª¤", err);
    }
    renderList(items);
    syncData();
  }

  async function syncData() {
    const newData = await fetchItems();
    updateList(newData);
  }

  async function fetchItems() {
    try {
      const response = await fetch("https://ozt1li4e01.execute-api.ap-northeast-3.amazonaws.com/prod/");
      const data = await response.json();
      console.log("å–å¾—è³‡æ–™æˆåŠŸ");
      return data;
    } catch (err) {
      console.error("å–å¾—è³‡æ–™éŒ¯èª¤", err);
      return [];
    }
  }

  function sortData(data) {
    return data.sort((a, b) => {
      const dayA = parseInt(a.WEEK_DAY, 10);
      const dayB = parseInt(b.WEEK_DAY, 10);
      if (dayA !== dayB) {
        return dayA - dayB;
      } else {
        const numA = parseInt(a.BATCH.replace('L', ''), 10);
        const numB = parseInt(b.BATCH.replace('L', ''), 10);
        return numA - numB;
      }
    });
  }

  function renderList(data) {
    const sortedData = sortData(data);
    const listContainer = document.getElementById("schedule-list");

    sortedData.forEach(item => {
      if (!document.getElementById(`card-${item.PK}`)) {
        const card = document.createElement("div");
        card.classList.add("card");
        card.id = `card-${item.PK}`;

        card.innerHTML = `
          <div class="card-header">
            <span class="week-day">æ˜ŸæœŸ ${item.WEEK_DAY}</span>
            <span class="batch">æ¢¯æ¬¡ ${item.BATCH}</span>
          </div>
          <div class="card-body">
            <p>èª²è™Ÿ: <strong>${item.PK}</strong></p>
            <p>ç‹€æ…‹: <span id="status-${item.PK}" class="${item.IS_OPEN ? 'open' : 'closed'}">
              ${item.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰"}
            </span></p>
            <div class="button-group">
              <button id="toggle-btn-${item.PK}" class="toggle-btn">
                ${item.IS_OPEN ? "é—œé–‰æ¢¯æ¬¡" : "é–‹å•Ÿæ¢¯æ¬¡"}
              </button>
              <button class="refresh-btn" onclick="sendLiffMessage('æ¢¯æ¬¡åˆ·æ–° ${item.PK}')">
                æ¢¯æ¬¡åˆ·æ–°
              </button>
            </div>
          </div>
        `;

        const toggleBtn = card.querySelector(`#toggle-btn-${item.PK}`);
        toggleBtn.addEventListener("click", () => {
          toggleStatus(item.PK);
        });

        listContainer.appendChild(card);
      }
    });
  }

  function updateList(newData) {
    const newItemsMap = new Map(newData.map(item => [item.PK, item]));

    newItemsMap.forEach((newItem, pk) => {
      const oldItem = items.find(i => i.PK === pk);
      if (!oldItem) {
        renderList([newItem]);
      } else if (oldItem.IS_OPEN !== newItem.IS_OPEN) {
        document.getElementById(`status-${pk}`).textContent = newItem.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰";
        document.getElementById(`status-${pk}`).className = newItem.IS_OPEN ? "open" : "closed";
        document.getElementById(`toggle-btn-${pk}`).textContent = newItem.IS_OPEN ? "é—œé–‰æ¢¯æ¬¡" : "é–‹å•Ÿæ¢¯æ¬¡";
      }
    });

    items = newData;
    reorderDomElements();
  }

  function reorderDomElements() {
    const sortedData = sortData(items);
    const listContainer = document.getElementById("schedule-list");
    sortedData.forEach(item => {
      const card = document.getElementById(`card-${item.PK}`);
      if (card) {
        listContainer.appendChild(card);
      }
    });
  }

  function toggleStatus(pk) {
    const item = items.find(i => i.PK === pk);
    if (!item) return;
    item.IS_OPEN = !item.IS_OPEN;
    document.getElementById(`status-${pk}`).textContent = item.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰";
    document.getElementById(`status-${pk}`).className = item.IS_OPEN ? "open" : "closed";
    document.getElementById(`toggle-btn-${pk}`).textContent = item.IS_OPEN ? "é—œé–‰æ¢¯æ¬¡" : "é–‹å•Ÿæ¢¯æ¬¡";
    sendLiffMessage(`æ¢¯æ¬¡ç‹€æ…‹ ${item.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰"} ${pk}`);
  }

  async function sendLiffMessage(messageText) {
    try {
      await liff.sendMessages([{ type: 'text', text: messageText }]);
    } catch (err) {
      console.error("sendMessages error", err);
      alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¢ºèªåœ¨ LINE in-app browser é–‹å•Ÿ");
    }
  }

  function showHelpView() {
    document.getElementById("courseDashboard-view").style.display = "none";
    document.getElementById("help-view").style.display = "block";
  }

  function showIndexView() {
    document.getElementById("help-view").style.display = "none";
    document.getElementById("courseDashboard-view").style.display = "block";
  }

  window.addEventListener("load", initCourseDashboard);
</script>
