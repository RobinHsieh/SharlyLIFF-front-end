<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é›²ç«¯å°åŠ©æ‰‹</title>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <!-- å¼•å…¥å¤–éƒ¨ CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- ğŸ“Œ index ä¸»è¦–åœ– -->
  <div id="studentOverview-view" class="view">
    <div class="container">
      <div class="header">
        <h2>è«‹å‡ç‹€æ³</h2>
        <a href="#" id="help-link">â“˜ æ“ä½œè¬›è§£</a>
      </div>
      <div id="schedule-list">
        <!-- JavaScript æœƒåœ¨é€™è£¡å‹•æ…‹æ’å…¥å¡ç‰‡ -->
      </div>
    </div>
  </div>

  <!-- ğŸ“Œ help æ“ä½œè¬›è§£è¦–åœ–ï¼ˆé è¨­éš±è—ï¼‰ -->
  <div id="help-view" class="view" style="display: none;">
    <div class="container">
      <div class="header">
        <h2>ğŸš€ æ“ä½œè¬›è§£</h2>
        <a href="#" id="back-link">è¿”å›</a>
      </div>
      
      <h2>1ï¸âƒ£ æ¢¯æ¬¡åˆ·æ–°</h2>
      <h3>ğŸ‘‰ åŒæ­¥ Google Drive è³‡æ–™å¤¾ï¼Œç¢ºä¿èª²ç¨‹åˆ—è¡¨ç‚ºæœ€æ–°ç‰ˆæœ¬ï¼š</h3>
      <ul>
          <li>ğŸ“‚ <strong>è®€å–</strong> ä½ æŒ‡å®šçš„æ¢¯æ¬¡å°æ‡‰çš„ Google Drive è³‡æ–™å¤¾ã€‚</li>
          <li>ğŸ” <strong>æ¯”å°</strong> ç¾æœ‰è³‡æ–™ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦ <strong>åŠ å…¥ã€åˆªé™¤æˆ–æ›´æ–°</strong> èª²å ‚ã€‚</li>
          <li>ğŸ”„ <strong>æ›´æ–°</strong> è³‡æ–™åº«ï¼Œç¢ºä¿ <strong>æª”æ¡ˆID å’Œåç¨±éƒ½æ˜¯æœ€æ–°çš„</strong>ã€‚</li>
      </ul>

      <h3>ğŸ”¹ æ€éº¼æ“ä½œï¼Ÿ</h3>
      <ul>
          <li>é»æ“Š <strong>ã€Œæ¢¯æ¬¡åˆ·æ–°ã€</strong> æŒ‰éˆ•ã€‚</li>
          <li>ç³»çµ±æœƒé€²è¡ŒåŒæ­¥ï¼Œä¸¦å›å ±ã€Œæ–°å¢/ä¿®æ”¹/åˆªé™¤ã€çš„å…§å®¹ã€‚</li>
      </ul>

      <div class="tip">
          âš ï¸ <strong>å°æé†’</strong>ï¼š
          <ul>
              <li>å¦‚æœæ¢¯æ¬¡å…§ <strong>æ²’æœ‰è®Šå‹•</strong>ï¼Œç³»çµ±æœƒå›å ±ã€Œç„¡éœ€æ›´æ–°ã€ã€‚</li>
              <li>å¦‚æœæŸå€‹æ¢¯æ¬¡ <strong>é‚„æ²’å»ºç«‹</strong>ï¼Œç³»çµ±æœƒå›å ±ã€Œæ•¸æ“šç¼ºå¤±ã€ã€‚</li>
          </ul>
      </div>

      <h2>2ï¸âƒ£ æ¢¯æ¬¡ç‹€æ…‹</h2>
      <h3>ğŸ‘‰ <strong>é–‹å•Ÿæˆ–é—œé–‰</strong> æŸå€‹æ¢¯æ¬¡çš„èª²å¾Œé›²ç«¯ï¼š</h3>
      <ul>
          <li>âœ… <strong>é–‹å•Ÿ</strong>ï¼šå­¸ç”Ÿå¯ä»¥ç”³è«‹è§€çœ‹èª²ç¨‹ã€‚</li>
          <li>ğŸš« <strong>é—œé–‰</strong>ï¼šæš«åœè©²æ¢¯æ¬¡çš„å½±ç‰‡å…±äº«ï¼Œç„¡æ³•ç”³è«‹è§€çœ‹ã€‚</li>
      </ul>

      <h3>ğŸ”¹ æ€éº¼æ“ä½œï¼Ÿ</h3>
      <ul>
          <li>é¸æ“‡ <strong>ã€Œé–‹å•Ÿæ¢¯æ¬¡ã€</strong> æˆ– <strong>ã€Œé—œé–‰æ¢¯æ¬¡ã€</strong> æŒ‰éˆ•ã€‚</li>
          <li>ç³»çµ±æœƒè®Šæ›´è©²æ¢¯æ¬¡çš„ç‹€æ…‹ï¼Œä¸¦é¡¯ç¤ºçµæœã€‚</li>
      </ul>
    </div>
  </div>

  <script>
    let items = [];  // å­˜æ”¾èª²ç¨‹è³‡æ–™ï¼ˆç›®å‰çš„ UI ç‹€æ…‹ï¼‰
    const liffId = "2006838266-YvLRJn6m";

    async function initLiff() {
      try {
        await liff.init({ liffId: liffId });
        console.log("LIFF init done");

        document.getElementById("help-link").addEventListener("click", showHelpView);
        document.getElementById("back-link").addEventListener("click", showIndexView);        
      } catch (err) {
        console.error("LIFF init error", err);
      }

      // **å…ˆé¡¯ç¤ºç›®å‰çš„ items**
      renderList(items);

      // **å¾Œå°åŒæ­¥æŠ“å–æœ€æ–°è³‡æ–™**
      syncData();
    }

    async function syncData() {
      const newData = await fetchItems();
      updateList(newData);
    }

    async function fetchItems() {
      try {
        const response = await fetch("https://ozt1li4e01.execute-api.ap-northeast-3.amazonaws.com/prod/");
        const data = await response.json();
        console.log("Fetch items done");
        return data;
      } catch (err) {
        console.error("Fetch items error", err);
        return []; // é¿å…å ±éŒ¯
      }
    }

    function sortData(data) {
      return data.sort((a, b) => {
        const dayA = parseInt(a.WEEK_DAY, 10);
        const dayB = parseInt(b.WEEK_DAY, 10);
        if (dayA !== dayB) {
          return dayA - dayB;
        } else {
          const numA = parseInt(a.BATCH.replace('L', ''), 10);
          const numB = parseInt(b.BATCH.replace('L', ''), 10);
          return numA - numB;
        }
      });
    }

    function renderList(data) {
      const sortedData = sortData(data);
      const listContainer = document.getElementById("schedule-list");

      sortedData.forEach((item, index) => {
        if (!document.getElementById(`card-${item.PK}`)) {
          const card = document.createElement("div");
          card.classList.add("card");
          card.id = `card-${item.PK}`;

          card.innerHTML = `
            <div class="card-header">
              <span class="week-day">æ˜ŸæœŸ ${item.WEEK_DAY}</span>
              <span class="batch">æ¢¯æ¬¡ ${item.BATCH}</span>
            </div>
            <div class="card-body">
              <p>èª²è™Ÿ: <strong>${item.PK}</strong></p>
              <p>ç‹€æ…‹: <span id="status-${item.PK}" class="${item.IS_OPEN ? 'open' : 'closed'}">${item.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰"}</span></p>
              <div class="button-group">
                <button class="leave-btn" onclick="sendLiffMessage('è«‹å‡é¡¯ç¤º ${item.PK}')">è«‹å‡é¡¯ç¤º</button>
                <button class="late-btn" onclick="sendLiffMessage('æ™šåˆ°é¡¯ç¤º ${item.PK}')">æ™šåˆ°é¡¯ç¤º</button>
                <button class="recital-btn" onclick="sendLiffMessage('èƒŒæ›¸é¡¯ç¤º ${item.PK}')">èƒŒæ›¸é¡¯ç¤º</button>
              </div>
            </div>
          `;

        //   // è¨­å®šã€Œæ›´æ”¹ç‹€æ…‹ã€æŒ‰éˆ•
        //   const toggleBtn = card.querySelector(`#toggle-btn-${item.PK}`);
        //   toggleBtn.addEventListener("click", () => {
        //     toggleStatus(item.PK);
        //   });

          listContainer.appendChild(card);
        }
      });
    }

    function updateList(newData) {
      // ç”¨ Map å¿«å– newDataï¼Œkey ç‚º PK
      const newItemsMap = new Map(newData.map(item => [item.PK, item]));

      // èˆ‡æœ¬åœ° items åšæ¯”è¼ƒ
      newItemsMap.forEach((newItem, pk) => {
        const oldItem = items.find(i => i.PK === pk);
        
        if (!oldItem) {
          // æ–°èª²ç¨‹ -> æ–°å¢å¡ç‰‡
          renderList([newItem]);
        } else if (oldItem.IS_OPEN !== newItem.IS_OPEN) {
          // ç‹€æ…‹æ”¹è®Š -> å±€éƒ¨æ›´æ–°è©²å¡ç‰‡ UI
          document.getElementById(`status-${pk}`).textContent = newItem.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰";
          document.getElementById(`status-${pk}`).className = newItem.IS_OPEN ? "open" : "closed";
        //   document.getElementById(`toggle-btn-${pk}`).textContent = newItem.IS_OPEN ? "é—œé–‰æ¢¯æ¬¡" : "é–‹å•Ÿæ¢¯æ¬¡";
        }
      });

      // æ›´æ–°æœ¬åœ° items
      items = newData;

      // **åœ¨æ­¤å‘¼å«é‡æ’å‡½å¼**ï¼Œç¢ºä¿ DOM å¡ç‰‡é †åºæ­£ç¢º
      reorderDomElements();
    }

    function reorderDomElements() {
      // 1. æ’åºç•¶å‰ items
      const sortedData = sortData(items);

      // 2. ä¾ç…§æ’åºçµæœé€ä¸€æŠŠå°æ‡‰å¡ç‰‡ append åˆ°æœ€æœ«ç«¯
      const listContainer = document.getElementById("schedule-list");

      sortedData.forEach(item => {
        const card = document.getElementById(`card-${item.PK}`);
        // å¦‚æœå¡ç‰‡å­˜åœ¨ï¼Œå°±æŠŠå®ƒé‡æ–° append ä¸€æ¬¡
        if (card) {
          listContainer.appendChild(card);
          // é€™è¡ŒæœƒæŠŠ card ç§»åˆ°å®¹å™¨æœ€å¾Œï¼Œå½¢æˆæœ€çµ‚çš„æ­£ç¢ºé †åº
        }
      });
    }

    // function toggleStatus(pk) {
    //   const item = items.find(i => i.PK === pk);
    //   if (!item) return;

    //   // **ç«‹å³æ›´æ–° UI**
    //   item.IS_OPEN = !item.IS_OPEN;
    //   document.getElementById(`status-${pk}`).textContent = item.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰";
    //   document.getElementById(`status-${pk}`).className = item.IS_OPEN ? "open" : "closed";
    //   document.getElementById(`toggle-btn-${pk}`).textContent = item.IS_OPEN ? "é—œé–‰æ¢¯æ¬¡" : "é–‹å•Ÿæ¢¯æ¬¡";

    //   // **ç™¼é€ LINE è¨Šæ¯**
    //   sendLiffMessage(`æ¢¯æ¬¡ç‹€æ…‹ ${item.IS_OPEN ? "é–‹å•Ÿ" : "é—œé–‰"} ${pk}`);
    // }

    async function sendLiffMessage(messageText) {
      try {
        await liff.sendMessages([{ type: 'text', text: messageText }]);
      } catch (err) {
        console.error("sendMessages error", err);
        alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¢ºèªåœ¨ LINE in-app browser é–‹å•Ÿ");
      }
    }

    function showHelpView() {
      document.getElementById("studentOverview-view").style.display = "none";
      document.getElementById("help-view").style.display = "block";
    }

    function showIndexView() {
      document.getElementById("help-view").style.display = "none";
      document.getElementById("studentOverview-view").style.display = "block";
    }

    window.onload = initLiff;
  </script>
</body>
</html>